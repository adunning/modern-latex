% Build this document with LuaTeX, a modern Unicode-aware LaTeX engine
% that uses system TTF and OTF font files.
% This is needed for the fontspec, microtype, and nolig packages.
%
% We're using KOMA Script to hand-tune footnotes and TOC appearance.
% It should be available in your texlive distribution,
% which is how most distros package LaTeX.
\documentclass[fontsize=10pt, numbers=endperiod]{scrbook}

% Margins: see http://practicaltypography.com/page-margins.html and
% http://practicaltypography.com/line-length.html
% We're aiming for 80-ish characters per line.
\usepackage[paperwidth=6.25in, paperheight=9.25in,
            layoutwidth=6in, layoutheight=9in,
            layouthoffset=0.125in, layoutvoffset=0.125in,
            inner=0.5in,outer=0.75in,top=0.5in,bottom=0.5in,
            includefoot,
            showcrop
           ]{geometry}

% Font specification.
% Use Equity for the body text,
% Roboto for sans serif,
% and mononoki for monospace text.
% Feel free to pick your own fonts or comment these lines out to use TeX's
% traditional Computer Modern.
\usepackage{fontspec}
\usepackage[fleqn]{amsmath}
%\setmainfont[Ligatures=TeX,
%             Numbers=Lowercase,
%             SmallCapsFont={Equity Caps A},
%             SmallCapsFeatures={StylisticSet=10}, % Set everything in \textsc{} as small caps
%             StylisticSet=01, % Slightly smaller quotes, asterisks, etc.
%            ]{Equity Text A}

\setmainfont[
    Ligatures=TeX,
    Numbers={Proportional,Lowercase},
    WordSpace=1.3,
    UprightFeatures={
        SizeFeatures={
            {Size={-9},Font=garamondpremrpro-capt},
            {Size={9-15},Font=garamondpremrpro},
            {Size={15-23},Font=garamondpremrpro-subh},
            {Size={23-},Font=garamondpremrpro-disp}
        },
    },
    BoldFeatures={
        SizeFeatures={
            {Size={-9},Font=garamondpremrpro-smbdcapt},
            {Size={9-15},Font=garamondpremrpro-smbd},
            {Size={15-23},Font=garamondpremrpro-smbdsubh},
            {Size={23-},Font=garamondpremrpro-smbddisp}
        },
    },
    ItalicFeatures={
        SizeFeatures={
            {Size={-9},Font=garamondpremrpro-itcapt},
            {Size={9-15},Font=garamondpremrpro-it},
            {Size={15-23},Font=garamondpremrpro-itsubh},
            {Size={23-},Font=garamondpremrpro-itdisp}
            },
    },
    BoldItalicFeatures={
        SizeFeatures={
            {Size={-9},Font=garamondpremrpro-smbditcapt},
            {Size={9-15},Font=garamondpremrpro-smbdit},
            {Size={15-23},Font=garamondpremrpro-smbditsubh},
            {Size={23-},Font=garamondpremrpro-smbditdisp}
        },
    },
]{Garamond Premier Pro}
\setsansfont[Ligatures=TeX,
             Scale=MatchUppercase,
             Style=Alternate, % Straight-legged R
             UprightFont = *-55Rg,
             ItalicFont = *-56It,
             BoldFont = *-65Md,
             BoldItalicFont = *-66MdIt
             ]{NHaasGroteskTXPro}
\setmonofont[Scale=MatchLowercase]{mononoki}

% We'll be using this quite a bit:
\newfontfamily{\lm}[%
    Ligatures=TeX,
    SmallCapsFont = * Caps
]{Latin Modern Roman}

\usepackage{polyglossia}
\setdefaultlanguage[variant=american]{english}
\setotherlanguage{french}

\usepackage{microtype} % Font expansion, protrusion, and other goodness

% Disable ligatures across grapheme boundaries
% (see the package manual for details.)
\usepackage[american]{selnolig}
\nolig{Th}{T|h}

% Use symbols for footnotes, resetting each page
\usepackage[perpage,bottom,symbol*]{footmisc}

% Left flush footnotes. See the KOMA Script manual.
\deffootnote[1em]{1em}{1em}{\thefootnotemark}
% Set the width of the rule separating body text and footnotes
\setfootnoterule{0.7\textwidth}

% Like many fonts, Equity's asterisk is already set in a "superscripted" form.
% Superscripting *that* makes it annoyingly small.
% To fix this, we have to redefine footnote marks so that they aren't superscript,
% then raise all the other symbols.
%
% Feel free to remove this if your body type doesn't have this peculiarity,
% but unfortunately many do.
% See http://tex.stackexchange.com/a/16241
%
% We use the Unicode symbols themselves (instead of \dagger, \ddagger, \P, etc.)
% because the latter fall back to Computer Modern/Latin Modern in some cases,
% (e.g., if you're using mathastext instead of unicode-math).
% Alternatively, you could use \textdagger, \textddagger, etc.,
% but this seems more concise.
\DefineFNsymbols*{tweaked}{%
    {*}%
    {\textsuperscript†}%
    {\textsuperscript‡}%
    {\textsuperscript{◊}}%
    {\textsuperscript{§}}%
    {**}%
    {\textsuperscript{††}}%
    {\textsuperscript{‡‡}}%
}
\setfnsymbol{tweaked}
\deffootnotemark{\thefootnotemark}

\DeclareTOCStyleEntry[%
    beforeskip=8pt,
    entrynumberformat = \addfontfeature{Numbers={Tabular,Uppercase}},
    pagenumberformat = \addfontfeature{Numbers={Tabular,Uppercase}},
    linefill = \TOCLineLeaderFill
]{tocline}{chapter}
\DeclareTOCStyleEntry[%
    beforeskip=1pt,
    entrynumberformat = \addfontfeature{Numbers={Tabular,Uppercase}},
    pagenumberformat = \addfontfeature{Numbers={Tabular,Uppercase}},
    indent=0.3in
]{tocline}{section}
\DeclareTOCStyleEntry[%
    beforeskip=0pt,
    entrynumberformat = \addfontfeature{Numbers={Tabular,Uppercase}},
    pagenumberformat = \addfontfeature{Numbers={Tabular,Uppercase}},
    indent=0.5in
]{tocline}{subsection}

% Don't use a sans font for description labels.
\addtokomafont{descriptionlabel}{\rmfamily}
\setkomafont{disposition}{\rmfamily}
\addtokomafont{chapter}{\addfontfeature{Numbers=Uppercase}}
\setkomafont{section}{\Large\itshape}
\setkomafont{subsection}{\large\itshape}

\setcapwidth[c]{.8\textwidth}
%\setcapmargin{0pt}
\setkomafont{caption}{\sffamily\footnotesize}
\setkomafont{captionlabel}{\sffamily\footnotesize}
\renewcommand*{\figureformat}{}
\renewcommand*{\tableformat}{}
\renewcommand*{\captionformat}{}

% Use uppercase numbers for numbered lists.
% (We're using lowercase ones for the body text.)
% See http://tex.stackexchange.com/a/133186
\usepackage{enumitem}
\setlist[enumerate]{font=\addfontfeatures{Numbers=Uppercase}}

% Custom footer
\usepackage{scrlayer-scrpage}
\clearpairofpagestyles
\pagestyle{scrheadings}
\setkomafont{pagefoot}{\upshape}
\cefoot*{\thepage} % \, is a TeX primitive for a thin space.
\cofoot*{\thepage} % \, is a TeX primitive for a thin space.

\usepackage{changepage} % For adjustwidth

\usepackage{mflogo} % for METAFONT
\usepackage{metalogo} % for \LuaLaTeX

\usepackage{multicol}

\usepackage{endnotes}
% Endnotes _mostly_ works... with Koma Script, no less.
% I suppose I can only grumble a little about the hackery below.
\renewcommand\enoteheading{\chapter{Notes}}
\renewcommand\enoteformat{\leavevmode\llap{\makeenmark}}
% OTF goodness...
\renewcommand\makeenmark{{\addfontfeature{VerticalPosition=Superior}\theenmark}}

\usepackage{listings}
\lstset
{
    language=[LaTeX]TeX,
    breaklines=false,
    basicstyle=\ttfamily\small,
    keywordstyle=\ttfamily\small,
    commentstyle=\ttfamily\small,
}

\newenvironment{leftfigure}
  {\par\vspace{0.5\baselineskip minus 0.3\baselineskip}\begin{adjustwidth}{2em}{0pt}}
  {\end{adjustwidth}\vspace*{0.3\baselineskip minus 0.1\baselineskip}}

\newenvironment{centerfigure}
  {\par\vspace{0.5\baselineskip minus 0.3\baselineskip}\begin{adjustwidth}{2em}{2em}\centering}
  {\end{adjustwidth}\vspace*{0.3\baselineskip minus 0.1\baselineskip}}

\usepackage{graphicx}

\usepackage{lipsum}

\title{Modern LaTeX}
\author{Matt Kline}
\date{\today}

% Custom footer
% Hyperlinks
\usepackage[unicode,pdfusetitle,hidelinks]{hyperref}

% Use \punckern to overlap periods, commas, and footnote markers
% for a tighter look.
% Care should be taken to not make it too tight - f" and the like can overlap
% if you're not careful.
\newcommand{\punckern}{\kern-0.2ex}
% For placing commas close to, or under, quotes they follow.
% We're programmers, and we blatantly disregard American typographical norms
% to put the quotes inside, but we can at least make it look a bit nicer.
\newcommand{\quotekern}{\kern-0.5ex}


% Create an unbreakable string of text in a monospaced font.
% Useful for `command --line --args`
\newcommand{\monobox}[1]{\mbox{\texttt{#1}}}

\newcommand{\otffrac}[2]{\mbox{%
    {\addfontfeature{VerticalPosition=Superior}#1}%
    ^^^^2044% Unicode fraction slash
    {\addfontfeature{VerticalPosition=Inferior}#2}%
}}
\newcommand{\otford}[2]{\mbox{%
    {\addfontfeature{Numbers=LowercaseOff}#1}%
    {\addfontfeature{VerticalPosition=Superior}#2}%
}}

% C++ looks nicer if the ++ is in a monospace font and raised a bit.
% Also, use uppercase numbers to match the capital C.
\newcommand{\plusplus}{\raisebox{0.2ex}{++}}
\newcommand{\cpp}[1]{C\kern-0.1ex\plusplus{\addfontfeature{Numbers=LowercaseOff}#1}}
\newcommand{\clang}[1]{C{\addfontfeature{Numbers=LowercaseOff}#1}}
\newcommand{\csharp}{C\raisebox{0.25ex}{\#}}

% Italicize new terms
\newcommand{\introduce}[1]{\textit{#1}}

% Letterspace acronyms a bit.
\newcommand{\acronym}[1]{\textsc{\addfontfeature{LetterSpace=8}#1}}

\newcommand{\chapref}[1]{%
    {\addfontfeature{Numbers={Proportional,Uppercase}}Chapter~\ref{#1}}%
}

% See http://tex.stackexchange.com/a/68310
\makeatletter
\let\runauthor\@author
\let\rundate\@date
\let\runtitle\@title
\makeatother

% Spend a bit more time to get better word spacing.
% See http://tex.stackexchange.com/a/52855/92465
\emergencystretch=1em

\begin{document}
\fontsize{10pt}{13pt}\selectfont

\frontmatter
\setcounter{secnumdepth}{0}
\setlength\parindent{0pt}

% Custom title instead of \maketitle
\pagenumbering{gobble}
\vspace*{1.5in}
\begin{center}
\fontsize{0.5in}{0.7in}\selectfont
Modern

\fontsize{1in}{1.1in}\selectfont
\LaTeX
\vfill
\LARGE
Matt Kline
\end{center}
\clearpage

\null
\vfill
Some crappy draft, typeset \today.
\vspace*{0.5in}

The author apologizes for any typos, misattributions, or other flubs,
and welcomes you to point them out on this book's Github
repository at \\
\url{https://github.com/mrkline/latex-book}, or via email to \\
\texttt{matt <at> bitbashing.io}

The author does not have a checking account with the Bank of San Serriffe,
but will happily purchase a beverage of your choice the next time we meet.

\vspace*{0.5in}
{\addfontfeature{Numbers={Proportional,Uppercase}}
Copyright © 2018 \\
by \runauthor
\bigskip

This book is licensed under the \\
Creative Commons Attribution-ShareAlike~4.0 International License. \\
Its full text is available at \\
\url{https://creativecommons.org/licenses/by-sa/4.0/legalcode}
}
\clearpage

\vspace*{1in}
{\itshape%
%\noindent To Donald, Leslie, \\
%Ellen, Erik, Jost, Matthew, \& Robert
%\bigskip

To Max, who once told me about a cool program he was using to type up
his college papers.
}
\cleardoublepage

\pagenumbering{roman}
\tableofcontents

\mainmatter
\setlength\parindent{1em}

\pagenumbering{arabic}
\setcounter{page}{1} % Restart page numbering after the ToC.
\cleardoublepage

\input{why}

\input{installation}

\input{hello}

\input{structure}

\input{textformatting}

\input{punctuation}

\input{pagelayout}

\input{math}

\input{fonts}

\input{micro}

\input{international}

\input{troubleshooting}

\appendix

\input{history}

\input{back}

\end{document}
